<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Forum Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-running {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .status-stopped {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }
        .status-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .log-entry:nth-child(even) {
            background-color: #e9ecef;
        }
        .btn-action {
            min-width: 120px;
        }
        .credentials-form {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-robot me-2"></i>Microsoft Forum Bot Dashboard
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card {{ 'status-running' if status.running else 'status-stopped' }}">
                    <div class="card-body text-center">
                        <i class="fas fa-power-off fa-2x mb-2"></i>
                        <h5 class="card-title">Bot Status</h5>
                        <p class="card-text">{{ 'Running' if status.running else 'Stopped' }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2 text-primary"></i>
                        <h5 class="card-title">Last Check</h5>
                        <p class="card-text">{{ status.last_check or 'Never' }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-list fa-2x mb-2 text-info"></i>
                        <h5 class="card-title">Total Cases</h5>
                        <p class="card-text">{{ status.total_cases }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                        <h5 class="card-title">Processed</h5>
                        <p class="card-text">{{ status.processed_cases }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        {% if status.error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> {{ status.error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Credentials Form -->
        <div class="credentials-form">
            <h4><i class="fas fa-key me-2"></i>Login Credentials</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" value="henry.mai">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" value="abc@123456">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary btn-action" onclick="testLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>Test Login
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-success btn-action" onclick="startBot()" {{ 'disabled' if status.running else '' }}>
                        <i class="fas fa-play me-2"></i>Start Bot
                    </button>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success btn-action w-100" onclick="startBot()" {{ 'disabled' if status.running else '' }}>
                                    <i class="fas fa-play me-2"></i>Start Monitoring
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-danger btn-action w-100" onclick="stopBot()" {{ 'disabled' if not status.running else '' }}>
                                    <i class="fas fa-stop me-2"></i>Stop Monitoring
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-warning btn-action w-100" onclick="runOnce()" {{ 'disabled' if not status.running else '' }}>
                                    <i class="fas fa-forward me-2"></i>Run Once
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-info btn-action w-100" onclick="refreshStatus()">
                                    <i class="fas fa-sync me-2"></i>Refresh Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-file-alt me-2"></i>Activity Logs</h5>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="logContainer">
                            <div class="log-entry">Loading logs...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let statusInterval;
        let logsInterval;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            refreshLogs();
            
            // Auto-refresh status every 5 seconds
            statusInterval = setInterval(refreshStatus, 5000);
            
            // Auto-refresh logs every 10 seconds
            logsInterval = setInterval(refreshLogs, 10000);
        });

        // API Functions
        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                showToast('API call failed: ' + error.message, 'error');
                return { success: false, message: error.message };
            }
        }

        // Bot Control Functions
        async function startBot() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }
            
            showToast('Starting bot...', 'info');
            const result = await apiCall('/api/start', 'POST', { username, password });
            
            if (result.success) {
                showToast('Bot started successfully!', 'success');
                refreshStatus();
            } else {
                showToast('Failed to start bot: ' + result.message, 'error');
            }
        }

        async function stopBot() {
            showToast('Stopping bot...', 'info');
            const result = await apiCall('/api/stop', 'POST');
            
            if (result.success) {
                showToast('Bot stopped successfully!', 'success');
                refreshStatus();
            } else {
                showToast('Failed to stop bot: ' + result.message, 'error');
            }
        }

        async function runOnce() {
            showToast('Running automation cycle...', 'info');
            const result = await apiCall('/api/run-once', 'POST');
            
            if (result.success) {
                showToast('Automation cycle completed!', 'success');
                refreshStatus();
            } else {
                showToast('Automation cycle failed: ' + result.message, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }
            
            showToast('Testing login...', 'info');
            const result = await apiCall('/api/login', 'POST', { username, password });
            
            if (result.success) {
                showToast('Login test successful!', 'success');
            } else {
                showToast('Login test failed: ' + result.message, 'error');
            }
        }

        async function refreshStatus() {
            try {
                const result = await apiCall('/api/status');
                if (result) {
                    updateStatusDisplay(result);
                }
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }

        async function refreshLogs() {
            try {
                const result = await apiCall('/api/logs');
                if (result && result.logs) {
                    updateLogsDisplay(result.logs);
                }
            } catch (error) {
                console.error('Failed to refresh logs:', error);
            }
        }

        // Display Update Functions
        function updateStatusDisplay(status) {
            // Update status cards
            const statusCards = document.querySelectorAll('.status-card');
            statusCards[0].className = `card status-card ${status.running ? 'status-running' : 'status-stopped'}`;
            statusCards[0].querySelector('.card-text').textContent = status.running ? 'Running' : 'Stopped';
            
            statusCards[1].querySelector('.card-text').textContent = status.last_check || 'Never';
            statusCards[2].querySelector('.card-text').textContent = status.total_cases;
            statusCards[3].querySelector('.card-text').textContent = status.processed_cases;
            
            // Update button states
            const startButtons = document.querySelectorAll('button[onclick="startBot()"]');
            const stopButtons = document.querySelectorAll('button[onclick="stopBot()"]');
            const runOnceButtons = document.querySelectorAll('button[onclick="runOnce()"]');
            
            startButtons.forEach(btn => btn.disabled = status.running);
            stopButtons.forEach(btn => btn.disabled = !status.running);
            runOnceButtons.forEach(btn => btn.disabled = !status.running);
            
            // Update error message
            const errorAlert = document.querySelector('.alert-danger');
            if (status.error_message) {
                if (!errorAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error:</strong> ${status.error_message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
                } else {
                    errorAlert.querySelector('strong').nextSibling.textContent = status.error_message;
                }
            } else if (errorAlert) {
                errorAlert.remove();
            }
        }

        function updateLogsDisplay(logs) {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = log;
                logContainer.appendChild(logEntry);
            });
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = document.getElementById('toastBody');
            
            // Set message
            toastBody.textContent = message;
            
            // Set type-specific styling
            toast.className = 'toast';
            if (type === 'success') {
                toast.classList.add('text-bg-success');
            } else if (type === 'error') {
                toast.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toast.classList.add('text-bg-warning');
            } else {
                toast.classList.add('text-bg-info');
            }
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusInterval) clearInterval(statusInterval);
            if (logsInterval) clearInterval(logsInterval);
        });
    </script>
</body>
</html>
